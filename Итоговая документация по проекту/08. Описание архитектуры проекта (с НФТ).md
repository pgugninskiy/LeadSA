
**`Заголовок: Архитектура модуля для создания новых блюд`**

![Image](https://github.com/user-attachments/assets/1960cef5-69e8-43b1-83c2-2a78baeb0adb)


# I. Пояснения к схеме
**Описание:**
1. Пользовательский интерфейс (UI)  
   - Описание: Визуальная часть системы, где менеджеры кухни или руководители могут взаимодействовать с системой.  
   - Функции: Позволяет создавать новое блюдо, отображать доступные ингредиенты и проверять готовность блюда к публикации в меню.  
   - Связи:  
     - Отправляет запросы в API сервиса формирования блюда.  
     - Получает список ингредиентов и результат сохранения блюда.  

2. Сервис формирования блюда  
   - Описание: Основной бэкенд-сервис, который содержит бизнес-логику процесса создания блюда.  
   - Функции:  
     - Обрабатывает запросы на создание блюда.  
     - Вызывает API-сервисы для получения списка доступных ингредиентов.  
   - Связи:  
     - Взаимодействует с системой управления продуктами (Inventory Management).  
     - Передаёт данные о новом блюде в "Систему управления меню".  

3. Система управления продуктами (Inventory Management)  
   - Описание: Внешняя система, которая отвечает за хранение данных об ингредиентах, их количестве и сроках годности.  
   - Функции:  
     - Возвращает список актуальных ингредиентов.  
     - Отправляет уведомления об изменениях.  
   - Связи:  
     - Обслуживает запросы от сервиса формирования блюда.  
     - При изменении данных отправляет события через брокер сообщений .  

4. Система управления меню (Menu Management)  
   - Описание: Сервис, который отвечает за отображение актуального меню на клиентских устройствах (приложения, терминалы и сайты).  
   - Функции:  
     - Добавляет новое блюдо в меню после его завершения и подтверждения.  
     - Синхронизирует данные с различными платформами (мобильное приложение, крупные экраны в закусочных и т.д.).  
     - Поддерживает события и уведомления об изменениях в меню.  

5. Брокер сообщений  
   - Описание: Используется для подписочной модели обновления ингредиентов.  
   - Функции:  
     - Служит связующим звеном между системой управления продуктами и сервисом формирования блюда.  
   - Связи:  
     - Получает события от Inventory Management.  
     - Пересылает события сервису формирования блюда.  

# II. Use Case: Создание блюда с резервированием ингредиентов
_Описание_
Данный use case описывает процесс создания нового блюда, включая выбор ингредиентов, их резервирование, финализацию рецепта и добавление блюда в меню.
**Акторы**:  

- **Пользователь (шеф-повар/менеджер кухни)** Отвечает за создание рецепта, выбор ингредиентов и финализацию блюда.
- **Система управления продуктами (Inventory Management)** Предоставляет актуальный список ингредиентов и управляет их резервированием/списанием.
- **Сервис формирования блюда (Recipe Management)** Обрабатывает действия пользователя, координирует резервирование ингредиентов и передает данные в другие системы.
- **Система управления меню (Menu Management)** Добавляет готовое блюдо в общее меню для клиентов.

**Предусловия**

- Пользователь имеет соответствующие права доступа для создания блюд.
- Система управления продуктами содержит актуальные данные об ингредиентах.

**Постусловия**

- Блюдо успешно создано и добавлено в меню.
- Зарезервированные ингредиенты списаны из остатков.
- Пользователь уведомлен об успешном завершении процесса.



# III. Описание потоков событий для процесса создания нового блюда

## **Основной поток событий (Main Flow)**

### **Инициация создания блюда**
1. **Шаг 1.1:** Пользователь открывает интерфейс "Создание нового блюда".  
2. **Шаг 1.2:** Сервис формирования блюд запрашивает актуальный список ингредиентов у системы управления продуктами.  
3. **Шаг 1.3:** Система управления продуктами предоставляет список доступных ингредиентов с указанием их количества.

### **Добавление ингредиентов**
4. **Шаг 2.1:** Пользователь выбирает необходимые ингредиенты из списка и добавляет их в "корзину рецепта".  
5. **Шаг 2.2:** Сервис формирования блюд отправляет запрос на резервирование выбранных ингредиентов в систему управления продуктами.  
6. **Шаг 2.3:** Система управления продуктами подтверждает успешное резервирование ингредиентов.

### **Изменение корзины**
7. **Шаг 3.1:** Пользователь может изменить состав "корзины рецепта":  
   - **Шаг 3.1.1:** Добавить новый ингредиент → выполнить новое резервирование.  
   - **Шаг 3.1.2:** Удалить существующий ингредиент → отменить ранее выполненное резервирование.

### **Финализация блюда**
8. **Шаг 4.1:** Сервис проверяет доступность всех зарезервированных ингредиентов.  
9. **Шаг 4.2:** Если все ингредиенты доступны, сервис списывает их из остатков системы управления продуктами.  
10. **Шаг 4.3:** Информация о новом блюде (рецепт, состав, цена) сохраняется в базе данных сервиса формирования блюд.  
11. **Шаг 4.4:** Данные о блюде передаются в систему управления меню.

### **Добавление в меню**
12. **Шаг 5.1:** Система управления меню обновляет данные и публикует новое блюдо в актуальных каналах (терминалы, мобильное приложение, сайт).

### **Уведомление**
13. **Шаг 6.1:** Пользователь получает уведомление об успешной публикации блюда.

---

## **Альтернативные потоки событий (Alternative Flows)**

### **АФ1: Недостаточно ингредиентов для резервирования**
- **Триггер:** На шаге 2.3 система управления продуктами сообщает, что недостаточно одного или нескольких ингредиентов.  
- **Действия:**  
  1. **Шаг АФ1.1:** Сервис формирования блюд информирует пользователя о недостатке ингредиентов.  
  2. **Шаг АФ1.2:** Пользователю предлагается:  
     - Изменить рецепт (удалить/заменить недоступный ингредиент).  
     - Отменить создание блюда.  
  3. **Шаг АФ1.3:** Если пользователь изменяет рецепт, процесс продолжается с шага 2.1.

### **АФ2: Отмена резервирования после удаления ингредиента**
- **Триггер:** На шаге 3.1.2 пользователь удаляет ингредиент из "корзины рецепта".  
- **Действия:**  
  1. **Шаг АФ2.1:** Сервис формирования блюд отправляет запрос на отмену резервирования данного ингредиента.  
  2. **Шаг АФ2.2:** Система управления продуктами подтверждает отмену резервирования.

---

## **Исключения (Exceptions)**

### **Исключение 1: Ошибка получения списка ингредиентов**
- **Триггер:** На шаге 1.2 сервис не может получить актуальный список ингредиентов из системы управления продуктами.  
- **Действия:**  
  1. **Шаг Исключение 1.1:** Сервис формирования блюд информирует пользователя об ошибке.  
  2. **Шаг Исключение 1.2:** Пользователю предлагается повторить попытку позже.

### **Исключение 2: Ошибка списания ингредиентов**
- **Триггер:** На шаге 4.2 система управления продуктами не может списать зарезервированные ингредиенты.  
- **Действия:**  
  1. **Шаг Исключение 2.1:** Сервис формирования блюд информирует пользователя об ошибке.  
  2. **Шаг Исключение 2.2:** Процесс создания блюда прерывается, а резервирование отменяется.

### **Исключение 3: Ошибка публикации блюда в меню**
- **Триггер:** На шаге 5.1 система управления меню не может опубликовать новое блюдо.  
- **Действия:**  
  1. **Шаг Исключение 3.1:** Сервис формирования блюд информирует пользователя об ошибке.  
  2. **Шаг Исключение 3.2:** Резервирование ингредиентов отменяется, а информация о блюде удаляется из базы данных.

---

### **Примечания**
1. **Пользовательский интерфейс:** Все сообщения об ошибках и уведомления должны быть четкими и понятными для пользователей, чтобы минимизировать путаницу.  
2. **Обработка исключений:** В случае возникновения исключений система должна автоматически выполнять откат изменений (например, отменять резервирование ингредиентов) для предотвращения некорректного состояния данных.  
3. **Логирование:** Все ошибки и исключения должны логироваться для последующего анализа и устранения проблем.  

Это описание потоков событий обеспечивает полное представление о процессе создания нового блюда, включая основные, альтернативные и исключительные сценарии.

* Sequence Diagram
![Image](https://github.com/user-attachments/assets/7cd2b990-9b81-4836-ad28-f0a3866945aa)

# IV. Техническое обоснование (API, кэширование)

## **API "Получить все доступные ингредиенты"**

### **Описание**
Сервис формирования блюд обращается к API **Системы управления продуктами** для получения актуального списка ингредиентов с детальной информацией (название, количество на складе, единицы измерения, цена за единицу). Это необходимо для того, чтобы пользователь мог видеть, какие ингредиенты доступны для создания нового блюда.

Данный метод является частью API **Системы управления продуктами** и вызывается в следующих случаях:

---

### **Когда вызывается метод?**

1. **При инициации создания нового блюда:**
   - Когда пользователь открывает интерфейс "Создание нового блюда", сервис автоматически вызывает метод **Получить все доступные ингредиенты** для загрузки актуального списка ингредиентов.
   - Этот список отображается пользователю для выбора необходимых компонентов рецепта.

2. **При обновлении списка ингредиентов:**
   - Если во время создания блюда произошли изменения в складских остатках (например, поступление новых партий ингредиентов или списание других), сервис может повторно вызвать этот метод для получения обновленной информации.
   - Такое обновление может быть инициировано либо автоматически (через периодическую проверку), либо по запросу пользователя.

3. **При восстановлении после ошибки:**
   - Если предыдущий запрос к API **Системы управления продуктами** завершился ошибкой (например, из-за временной недоступности сервера), сервис может повторно вызвать метод **Получить все доступные ингредиенты** после восстановления соединения.

---

### **Для чего используется результат метода?**

Результат метода содержит подробную информацию о каждом доступном ингредиенте, включая:
- Название ингредиента.
- Количество на складе.
- Единицы измерения (кг, л, шт. и т.д.).
- Цена за единицу.
- Дата последнего поступления (опционально).

**Эта информация используется для:**
- Отображения списка ингредиентов пользователю.
- Проверки достаточности ингредиентов при добавлении их в рецепт.
- Расчета стоимости блюда на основе цен ингредиентов.

---

### **Пример запроса и ответа**

#### **Запрос:**
```
GET /api/products/available
```

#### **Ответ:**
```json
[
  {
    "id": 1,
    "name": "Куриная грудка",
    "quantity": 50, // в кг
    "unit": "kg",
    "price_per_unit": 200 // в валюте
  },
  {
    "id": 2,
    "name": "Оливковое масло",
    "quantity": 100, // в л
    "unit": "l",
    "price_per_unit": 150
  }
]
```

---

### **Где хранить список ингредиентов?**

1. **Кэширование:**
   - Список ингредиентов можно закэшировать в памяти сервиса. Это особенно удобно, если данные запрашиваются часто, так как нет необходимости постоянно обращаться к основной системе.
   - Однако возникает риск работы с устаревшими данными, если изменяются доступные ингредиенты (например, произошла поставка или списание).

2. **Подписка на изменения:**
   - **Система управления продуктами** отправляет уведомления (события) в наш сервис, когда происходят изменения (например, новый продукт на складе или списание). Это делает данные всегда актуальными.

---

### **Как актуализировать список ингредиентов?**

- **Механизм подписки на изменения:**
  - При использовании event-driven архитектуры сервис подписывается на события от **Системы управления продуктами**.
  - Например, при поступлении новой партии ингредиентов или списании старых система отправляет событие, которое обновляет данные в кэше сервиса.

---

### **Преимущества и недостатки**

#### **Кэширование:**
- **Преимущества:**
  - Быстрое выполнение запросов.
  - Минимальная нагрузка на внешнюю систему.
- **Недостатки:**
  - Риск работы с устаревшими данными.
  - Требуется реализовать механизм для проверки и сброса кэша.

#### **Подписка на изменения:**
- **Преимущества:**
  - Данные в сервисе всегда будут актуальными при правильной реализации.
- **Недостатки:**
  - Высокая сложность внедрения event-driven архитектуры.

---

### **Рекомендации**
- Для достижения оптимального баланса между производительностью и актуальностью данных рекомендуется комбинировать оба подхода:
  - Использовать кэширование для частых запросов.
  - Подписываться на события для обновления данных в реальном времени.

---

